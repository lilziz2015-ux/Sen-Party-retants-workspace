<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard — Sen Party Rentals Pro</title>

<link rel="stylesheet" href="assets/style.css" />
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="logo">
    <img src="02B58D79-6737-47EA-8099-73006879E55A Small.jpeg" alt="Logo">
    <h2>Sen Party Rentals Pro</h2>
  </div>
  <nav>
    <a href="index.html" class="active">🏠 Dashboard</a>
    <a href="bookings.html">📅 Bookings</a>
    <a href="calendar.html">🗓️ Calendar</a>
    <a href="customers.html">👥 Customers</a>
    <a href="invoices.html">🧾 Invoices</a>
    <a href="delivery.html">🚚 Delivery</a>
    <a href="settings.html">⚙️ Settings</a>
  </nav>
</aside>

<!-- Main -->
<main class="main">
  <header class="topbar">
    <button class="menu-toggle" id="menuToggle">☰</button>
    <div>
      <h1>Dashboard</h1>
      <p class="muted">Welcome back! Here's your business overview.</p>
    </div>
  </header>

  <!-- Stats Section -->
  <section class="card">
    <h2>Quick Stats</h2>
    <div class="stats-grid">
      <div class="stat">
        <h3>Total Bookings</h3>
        <p class="stat-value" id="statBookings">0</p>
      </div>
      <div class="stat">
        <h3>Today’s Bookings</h3>
        <p class="stat-value" id="statToday">0</p>
      </div>
      <div class="stat">
        <h3>Total Revenue</h3>
        <p class="stat-value" id="statRevenue">$0.00</p>
      </div>
      <div class="stat">
        <h3>Pending Balance</h3>
        <p class="stat-value" id="statPending">$0.00</p>
      </div>
    </div>
  </section>

  <!-- Recent Bookings -->
  <section class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Recent Bookings</h2>
      <button class="btn-primary" onclick="window.location.href='bookings.html'">+ Add Booking</button>
    </div>
    <div style="overflow-x:auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer</th>
            <th>Type</th>
            <th>Total</th>
            <th>Deposit</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody id="recentTable">
          <tr><td colspan="6" class="muted">No bookings found.</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Chart -->
  <section class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Revenue Overview</h2>
      <button class="btn-outline" onclick="window.location.href='invoices.html'">📊 View Reports</button>
    </div>
    <canvas id="revenueChart" height="100"></canvas>
  </section>

  <footer>
    <p>© 2025 Sen Party Rentals Pro — All rights reserved.</p>
  </footer>
</main>

<script type="module">
import { getBookings, formatCurrency, calcBalance } from './assets/app.js';

// --- Sidebar Toggle ---
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('menuToggle');
toggleBtn.addEventListener('click', () => {
  sidebar.classList.toggle('show');
});

// --- Dashboard Logic ---
function updateDashboard() {
  const bookings = getBookings();
  const today = new Date().toISOString().slice(0, 10);

  const totalBookings = bookings.length;
  const todayBookings = bookings.filter(b => b.date === today).length;
  const totalRevenue = bookings.reduce((s, b) => s + (parseFloat(b.total) || 0), 0);
  const pending = bookings.reduce((s, b) => s + (parseFloat(b.total - b.deposit) || 0), 0);

  document.getElementById('statBookings').textContent = totalBookings;
  document.getElementById('statToday').textContent = todayBookings;
  document.getElementById('statRevenue').textContent = formatCurrency(totalRevenue);
  document.getElementById('statPending').textContent = formatCurrency(pending);

  // Render Recent Bookings
  const table = document.getElementById('recentTable');
  table.innerHTML = "";
  const recent = [...bookings].sort((a, b) => b.id - a.id).slice(0, 5);

  if (recent.length === 0) {
    table.innerHTML = "<tr><td colspan='6' class='muted'>No bookings found.</td></tr>";
  } else {
    recent.forEach(b => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${b.date}</td>
        <td>${b.customer}</td>
        <td>${b.type === 'pickup' ? '🟡 Pickup' : '🟢 Delivery'}</td>
        <td>${formatCurrency(b.total)}</td>
        <td>${formatCurrency(b.deposit)}</td>
        <td>${formatCurrency(calcBalance(b.total, b.deposit))}</td>`;
      table.appendChild(tr);
    });
  }

  // Update Chart
  renderChart(bookings);
}

// --- Chart.js ---
function renderChart(bookings) {
  const monthly = {};
  bookings.forEach(b => {
    const month = new Date(b.date).toLocaleString('default', { month: 'short' });
    monthly[month] = (monthly[month] || 0) + parseFloat(b.total || 0);
  });

  const ctx = document.getElementById('revenueChart');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(monthly),
      datasets: [{
        label: 'Revenue',
        data: Object.values(monthly),
        backgroundColor: '#0078ff',
        borderRadius: 6,
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#333' } },
        x: { ticks: { color: '#333' } }
      }
    }
  });
}

updateDashboard();
window.addEventListener('bookingsUpdated', updateDashboard);
</script>

</body>
</html>